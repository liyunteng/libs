/*
 * test.c - test
 *
 * Date   : 2021/03/24
 */

#include "opus-head.h"
#include <stdint.h>
#include <assert.h>
#include <string.h>

static const uint8_t opus_channel_map[8][8] = {
    { 0 },
    { 0,1 },
    { 0,2,1 },
    { 0,1,2,3 },
    { 0,4,1,2,3 },
    { 0,4,1,2,3,5 },
    { 0,4,1,2,3,5,6 },
    { 0,6,1,2,3,4,5,7 },
};

static int opus_onframe(uint8_t toc, const void* frame, int size)
{
    return 0;
}

static void opus_packet_getframes_test(void)
{
    const uint8_t data[] = { 0x7F ,0xF0 ,0xF1 ,0x00 ,0x78 ,0xFC ,0x6F ,0xE9 ,0x04 ,0x92 ,0x8B ,0x99 ,0xEF ,0x20 ,0x00 ,0x20 ,0x58 ,0x7E ,0x2E ,0x82 ,0xC6 ,0xCC ,0x27 ,0x92 ,0x56 ,0x45 ,0xA7 ,0x5C ,0xDD ,0xAB ,0x41 ,0x1F ,0xD0 ,0x4A ,0x49 ,0xBB ,0xEA ,0xC2 ,0x1F ,0xD5 ,0x2A ,0x67 ,0xD2 ,0xF4 ,0x3F ,0x9E ,0xF4 ,0x52 ,0x38 ,0x41 ,0xBE ,0x55 ,0x4C ,0xFB ,0xD7 ,0x18 ,0xF1 ,0x93 ,0x26 ,0x36 ,0x46 ,0x01 ,0x41 ,0x85 ,0x7E ,0xAD ,0xB0 ,0x37 ,0x4B ,0xB7 ,0x15 ,0xB1 ,0x4C ,0x81 ,0x05 ,0x99 ,0xF8 ,0xE1 ,0xB6 ,0x54 };
    opus_packet_getframes(data, sizeof(data), opus_onframe, NULL);
}

void opus_head_test(void)
{
    uint8_t data[29];
    const uint8_t src[] = { 0x4f, 0x70, 0x75, 0x73, 0x48, 0x65, 0x61, 0x64, 0x01, 0x02, 0x78, 0x00, 0x80, 0xbb, 0x00, 0x00, 0x00, 0x00, 0x00 };

    struct opus_head_t opus;
    assert(sizeof(src) == opus_head_load(src, sizeof(src), &opus));
    assert(1 == opus.version && 2 == opus.channels && 120 == opus.pre_skip && 48000 == opus.input_sample_rate && 0 == opus.output_gain);
    assert(0 == opus.channel_mapping_family && 1 == opus.stream_count && 1 == opus.coupled_count);
    assert(0 == memcmp(opus_channel_map[opus.channels-1], opus.channel_mapping, 8));
    assert(sizeof(src) == opus_head_save(&opus, data, sizeof(data)));
    assert(0 == memcmp(src, data, sizeof(src)));

    opus_packet_getframes_test();
}

int main(void)
{
    opus_head_test();
    return 0;
}
